using System.Collections;
using Cysharp.Threading.Tasks;
using NUnit.Framework;
using UnityEngine.TestTools;

namespace Mirage.Tests.Runtime.Host
{
    [Category("LoadsScene")]
    public class CharacterSpawnerTest : HostSetupWithSceneManager<MockComponent>
    {
        private CharacterSpawner spawner;

        public override void ExtraSetup()
        {
            // call base for SceneManager Setup
            base.ExtraSetup();

            // disable so awake isn't called till setup finished
            networkManagerGo.SetActive(false);
            spawner = networkManagerGo.AddComponent<CharacterSpawner>();

            spawner.Client = client;
            spawner.Server = server;
            spawner.SceneManager = sceneManager;
            spawner.ClientObjectManager = clientObjectManager;
            spawner.ServerObjectManager = serverObjectManager;

            spawner.PlayerPrefab = CreateNetworkIdentity();

            spawner.AutoSpawn = false;
            networkManagerGo.SetActive(true);
        }

        [UnityTest]
        public IEnumerator DontAutoSpawnTest() => UniTask.ToCoroutine(async () =>
        {
            var invokeAddPlayerMessage = false;
            ServerMessageHandler.RegisterHandler<AddCharacterMessage>(msg => invokeAddPlayerMessage = true);

            sceneManager.ServerLoadSceneNormal(TestScene.Path);
            // wait for messages to be processed
            await UniTask.Yield();

            Assert.That(invokeAddPlayerMessage, Is.False);

        });

        [UnityTest]
        public IEnumerator ManualSpawnTest() => UniTask.ToCoroutine(async () =>
        {
            var invokeAddPlayerMessage = false;
            ServerMessageHandler.RegisterHandler<AddCharacterMessage>(msg => invokeAddPlayerMessage = true);

            spawner.RequestServerSpawnPlayer();

            // wait for messages to be processed
            await UniTask.Yield();

            Assert.That(invokeAddPlayerMessage, Is.True);
        });
    }
}
